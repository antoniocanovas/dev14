<odoo>
    <record id="product_bulk_computations" model="base.automation">
            <field name="name">=> Bulk product in picking</field>
            <field name="model_id" ref="stock.model_stock_picking"/>
            <field name="state">code</field>
            <field name="code">
# SM cost in Purchase Kits, proportional to original BOM:
for sm in record.move_ids_without_package:

    # ONLY kits products and purchases:
    if (sm.product_id.id != sm.purchase_line_id.product_id.id) and (record.purchase_id.id):
      cost_unit = sm.purchase_line_id.price_subtotal / sm.purchase_line_id.product_qty

      # Proportional costs from BOM:
      bomline = env['mrp.bom.line'].search([('product_id','=',sm.product_id.id), ('bom_id.type','=','phantom'),
        ('bom_id.product_tmpl_id','=',sm.purchase_line_id.product_id.product_tmpl_id.id)])[0]
      if bomline.id:
        cost_bom_product_id, cost_total, cost_bom_percentage = 0, 0, 1
        for li in bomline.bom_id.bom_line_ids:
          cost_total += li.product_id.standard_price * li.product_qty
          if li.product_id.id == sm.product_id.id:
            cost_bom_product_id += li.product_id.standard_price * li.product_qty
        if cost_total > 0:
          cost_bom_percentage = cost_bom_product_id / cost_total

        # RATIO of bought products and deployed on Kit:
        ratio = bomline.product_qty / bomline.bom_id.product_qty
        sm['price_unit'] = cost_unit / ratio * cost_bom_percentage

    # Update QTY_DELIVERY for Kits on purchase_order_line (by default only integer):
    if (sm.product_id.id != sm.purchase_line_id.product_id.id) and (record.purchase_id.id) and (record.state == 'done'):
      sm_allpickings = env['stock.move'].search([('product_id','=',sm.product_id.id),
        ('purchase_line_id','=',sm.purchase_line_id.id), ('state','=','done')])
      totaldelivery = 0
      for sm in sm_allpickings:
        totaldelivery += sm.product_qty
      sm.purchase_line_id['qty_received'] = totaldelivery / ratio
            </field>
            <field name="trigger">on_write</field>
            <field name="trigger_field_ids" eval="[(6,0, [ref('stock.field_stock_picking__state')])]"/>
            <field name="filter_pre_domain"></field>
            <field name="filter_domain">[('purchase_id','!=',False)]</field>
            <field name="active" eval="True"/>
        </record>

</odoo>
